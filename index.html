<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Crafts Dofus 3</title>
  <!-- Inclusion de Roboto pour une typographie moderne -->
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
  <style>
    /* Palette et typographie inspirées de Dofus avec couleurs personnalisées */
    body {
      margin: 0;
      padding: 0;
      font-family: 'Roboto', system-ui, serif;
      background-color: #F7F2E6; /* Beige doux */
      color: #2C3E50;
    }
    header {
      position: relative;
      padding: 20px;
      text-align: center;
      font-size: 28px;
      font-weight: bold;
      background-color: #97a800; /* Vert personnalisé */
      color: #FFF;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    /* Bouton Reset en haut à gauche */
    #resetDataButton {
      position: absolute;
      left: 20px;
      top: 20px;
      padding: 5px 10px;
      font-size: 14px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      background-color: #C0392B;
      color: #FFF;
    }
    /* Bouton Thème en haut à droite */
    #themeToggle {
      position: absolute;
      right: 20px;
      top: 20px;
      padding: 5px 10px;
      border: none;
      border-radius: 4px;
      font-weight: 500;
      cursor: pointer;
      background-color: #97a800;
      color: #FFF;
    }
    .container {
      padding: 20px;
      max-width: 1200px;
      margin: 0 auto;
    }
    h2 {
      margin-top: 30px;
      padding-bottom: 5px;
      border-bottom: 2px solid #97a800;
    }
    /* Champs de filtre */
    .filter-input {
      width: 100%;
      padding: 5px;
      margin-bottom: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      box-sizing: border-box;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
      background-color: #FFF;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    th, td {
      padding: 10px;
      text-align: left;
      border: 1px solid #ddd;
    }
    th {
      background-color: #E8E8E8;
      color: #2C3E50;
      cursor: pointer;
      user-select: none;
    }
    /* Indicateur de tri */
    .sort-indicator {
      margin-left: 5px;
      font-weight: normal;
      color: #888;
    }
    .sort-indicator.active {
      font-weight: bold;
      color: #000;
    }
    /* Boutons */
    .module-button {
      margin-bottom: 15px;
      padding: 10px 15px;
      border: none;
      border-radius: 4px;
      font-weight: 500;
      cursor: pointer;
      transition: background-color 0.3s;
      background-color: #97a800;
      color: #FFF;
    }
    .module-button:hover {
      background-color: #7e9000;
    }
    /* Réduction de la largeur des inputs inline */
    .inline-input {
      width: 60px;
    }
    /* --- Modales --- */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0, 0, 0, 0.8);
    }
    .modal-content {
      background-color: #FFF;
      margin: 10% auto;
      padding: 20px;
      border: 1px solid #ddd;
      width: 400px;
      max-width: 90%;
      box-sizing: border-box;
      border-radius: 8px;
      font-family: 'Roboto', system-ui, serif;
      color: #2C3E50;
    }
    .close {
      float: right;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
    }
    .close:hover, .close:focus {
      opacity: 0.8;
    }
    input[type="text"], input[type="number"], textarea {
      width: 100%;
      padding: 8px;
      margin: 5px 0 15px 0;
      border: 1px solid #ddd;
      border-radius: 4px;
      box-sizing: border-box;
      font-family: 'Roboto', system-ui, serif;
    }
    label {
      font-weight: 500;
    }
    /* Détail hiérarchisé */
    .breakdown {
      margin-top: 15px;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      background-color: #FFF;
    }
    .breakdown ul {
      list-style-type: none;
      padding-left: 20px;
    }
    .breakdown li {
      margin-bottom: 5px;
    }
    .breakdown .title {
      font-weight: bold;
      margin-top: 10px;
    }
    /* Résultat détaillé */
    .result-container {
      margin-top: 15px;
      padding: 15px;
      border: 1px solid #ddd;
      border-radius: 8px;
      background-color: #e4e0d7;
      font-size: 14px;
    }
    .result-container h3 {
      margin-top: 0;
      margin-bottom: 10px;
      font-size: 18px;
      color: #2C3E50;
    }
    .result-table, .breakdown-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    .result-table th, .result-table td,
    .breakdown-table th, .breakdown-table td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: left;
    }
    .result-table th, .breakdown-table th {
      background-color: #DFE6E9;
      font-weight: bold;
    }
    .result-table tr:nth-child(even), .breakdown-table tr:nth-child(even) {
      background-color: #F8F8F8;
    }
    /* Espacement pour le bouton "Calculer" dans le modal ressources */
    #buySellModal .module-button {
      margin-top: 15px;
    }
    /* Mode sombre (adaptation minimale) */
    body.dark-theme {
      background-color: #EDEDED;
      color: #CCC;
    }
    body.dark-theme header {
      background-color: #3B3B3B;
      color: #FF9C00;
      border-bottom-color: #FF9C00;
    }
  </style>
</head>
<body>
  <header>
    <button id="resetDataButton" onclick="openResetModal()">Reset données</button>
    Crafts Dofus 3
    <button id="themeToggle" onclick="toggleTheme()">Clair</button>
  </header>
  <div class="container">
    <!-- Module 1 : Gestion des Crafts -->
    <h2>Liste des Crafts</h2>
    <input type="text" id="craftFilterInput" class="filter-input" placeholder="Filtrer les crafts...">
    <button class="module-button" onclick="openCraftModal()">Ajouter un Craft</button>
    <table id="craftTable">
      <thead>
        <tr>
          <th onclick="toggleCraftSort('name')">Nom <span class="sort-indicator" id="craft-sort-name"></span></th>
          <th onclick="toggleCraftSort('ingredients')">Ingrédients <span class="sort-indicator" id="craft-sort-ingredients"></span></th>
          <th onclick="toggleCraftSort('resaleValue')">Valeur de revente (x10) <span class="sort-indicator" id="craft-sort-resaleValue"></span></th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <!-- Module 2 : Inventaire d'ingrédients -->
    <h2>Inventaire d'ingrédients</h2>
    <input type="text" id="ingredientFilterInput" class="filter-input" placeholder="Filtrer les ingrédients...">
    <button class="module-button" onclick="openIngredientModal()">Ajouter un ingrédient</button>
    <table id="ingredientTable">
      <thead>
        <tr>
          <th onclick="toggleIngredientSort('name')">Nom <span class="sort-indicator" id="ingredient-sort-name"></span></th>
          <th onclick="toggleIngredientSort('quantity')">Quantité <span class="sort-indicator" id="ingredient-sort-quantity"></span></th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <!-- Module 3 : Rentabilité à partir de l'inventaire -->
    <h2>Rentabilité à partir de l'inventaire</h2>
    <input type="text" id="profitFilterInput" class="filter-input" placeholder="Filtrer la rentabilité...">
    <button class="module-button" onclick="calculateProfitability()">Calculer</button>
    <table id="profitTable">
      <thead>
        <tr>
          <th onclick="toggleProfitSort('craft')">Craft <span class="sort-indicator" id="profit-sort-craft"></span></th>
          <th onclick="toggleProfitSort('possibleCount')">Nb Réalisables <span class="sort-indicator" id="profit-sort-possibleCount"></span></th>
          <th onclick="toggleProfitSort('profit')">Profit potentiel <span class="sort-indicator" id="profit-sort-profit"></span></th>
          <th>Détails</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <!-- Module 4 : Calcul de ressources -->
    <h2>Calcul de ressources</h2>
    <input type="text" id="buySellFilterInput" class="filter-input" placeholder="Filtrer les crafts...">
    <table id="buySellTable">
      <thead>
        <tr>
          <th onclick="toggleBuySellSort('name')">Craft <span class="sort-indicator" id="buySell-sort-name"></span></th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- Modal Craft (Module 1) -->
  <div id="craftModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeCraftModal()">&times;</span>
      <h2 id="craftModalTitle">Ajouter un Craft</h2>
      <input type="hidden" id="craftId">
      <label for="craftName">Craft</label>
      <input type="text" id="craftName" placeholder="Nom du craft">
      <label for="craftIngredients">Ingrédients <i style="font-weight: normal;">ex : 1 ortie, 2 eau, 1 orge</i></label>
      <textarea id="craftIngredients" placeholder="Liste des ingrédients"></textarea>
      <label for="craftResale">Valeur de revente <span style="font-weight: normal;">(x10)</span></label>
      <input type="number" id="craftResale" class="inline-input" placeholder="Valeur">
      <button class="module-button" onclick="saveCraft()">Sauvegarder</button>
    </div>
  </div>

  <!-- Modal Ingrédient (Module 2) -->
  <div id="ingredientModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeIngredientModal()">&times;</span>
      <h2 id="ingredientModalTitle">Ajouter un ingrédient</h2>
      <input type="hidden" id="ingredientId">
      <label for="ingredientName">Ingrédient</label>
      <input type="text" id="ingredientName" placeholder="Nom">
      <label for="ingredientQuantity">Quantité</label>
      <input type="number" id="ingredientQuantity" class="inline-input" placeholder="Quantité">
      <button class="module-button" onclick="saveIngredient()">Sauvegarder</button>
    </div>
  </div>

  <!-- Modal Calcul de ressources (Module 4) -->
  <div id="buySellModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeBuySellModal()">&times;</span>
      <h2 id="buySellModalTitle">Calcul de ressources - <span id="currentCraftName"></span></h2>
      <div id="buySellModalBody">
        <!-- Zone de formulaire dynamique -->
      </div>
      <button class="module-button" onclick="calculateBuySell()">Calculer</button>
      <p id="buySellResult"></p>
    </div>
  </div>

  <!-- Modal Détails de consommation (Module 3) -->
  <div id="consumptionModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeConsumptionModal()">&times;</span>
      <h2 id="consumptionModalTitle">Détails de consommation</h2>
      <div id="consumptionModalBody" class="breakdown"></div>
    </div>
  </div>

  <!-- Modal Reset Données -->
  <div id="resetModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeResetModal()">&times;</span>
      <h2>Confirmation</h2>
      <p>Voulez-vous vraiment réinitialiser toutes les données ?</p>
      <button class="module-button" onclick="resetData()">Confirmer</button>
      <button class="module-button" onclick="closeResetModal()">Annuler</button>
    </div>
  </div>

  <script>
    // Variables globales pour filtres et tris
    let craftFilterText = "";
    let ingredientFilterText = "";
    let profitFilterText = "";
    let buySellFilterText = "";
    let craftSort = { column: "", direction: "asc" };
    let ingredientSort = { column: "", direction: "asc" };
    let profitSort = { column: "", direction: "asc" };
    let buySellSort = { column: "", direction: "asc" };

    // Variables globales pour données
    let crafts = [];
    let ingredients = [];
    let currentBuySellCraft = null;

    // Fonction de formatage pour l'affichage
    function formatDisplayName(name) {
      const exceptions = ["de", "du", "la", "le", "les", "des", "au", "aux", "et", "à", "en"];
      let words = name.split(" ");
      for (let i = 0; i < words.length; i++) {
        if (i === 0 || !exceptions.includes(words[i])) {
          words[i] = words[i].charAt(0).toUpperCase() + words[i].slice(1);
        }
      }
      return words.join(" ");
    }

    /* ---------- Gestion du Thème ---------- */
    function applyTheme(theme) {
      if (theme === 'dark') {
        document.body.classList.add('dark-theme');
        document.body.classList.remove('light-theme');
        document.querySelectorAll('.module-button').forEach(btn => {
          btn.classList.add('dark-theme');
          btn.classList.remove('light-theme');
        });
        document.getElementById('themeToggle').classList.add('dark-theme');
        document.getElementById('themeToggle').classList.remove('light-theme');
        document.getElementById('themeToggle').innerText = "Clair";
      } else {
        document.body.classList.add('light-theme');
        document.body.classList.remove('dark-theme');
        document.querySelectorAll('.module-button').forEach(btn => {
          btn.classList.add('light-theme');
          btn.classList.remove('dark-theme');
        });
        document.getElementById('themeToggle').classList.add('light-theme');
        document.getElementById('themeToggle').classList.remove('dark-theme');
        document.getElementById('themeToggle').innerText = "Sombre";
      }
    }
    function toggleTheme() {
      let currentTheme = localStorage.getItem('theme') || 'light';
      const newTheme = currentTheme === 'light' ? 'dark' : 'light';
      localStorage.setItem('theme', newTheme);
      applyTheme(newTheme);
    }
    window.addEventListener('load', () => {
      const savedTheme = localStorage.getItem('theme') || 'light';
      applyTheme(savedTheme);
      document.getElementById('craftFilterInput').addEventListener('input', function() {
        craftFilterText = this.value.toLowerCase();
        renderCrafts();
      });
      document.getElementById('ingredientFilterInput').addEventListener('input', function() {
        ingredientFilterText = this.value.toLowerCase();
        renderIngredients();
      });
      document.getElementById('profitFilterInput').addEventListener('input', function() {
        profitFilterText = this.value.toLowerCase();
        calculateProfitability();
      });
      document.getElementById('buySellFilterInput').addEventListener('input', function() {
        buySellFilterText = this.value.toLowerCase();
        renderBuySell();
      });
    });

    /* ---------- Stockage des Données ---------- */
    function loadData() {
      const storedCrafts = localStorage.getItem('crafts');
      const storedIngredients = localStorage.getItem('ingredients');
      if (storedCrafts) {
        crafts = JSON.parse(storedCrafts);
        crafts.forEach(c => {
          c.name = c.name.toLowerCase();
          c.ingredients = c.ingredients.toLowerCase();
        });
      }
      if (storedIngredients) {
        ingredients = JSON.parse(storedIngredients);
        ingredients.forEach(i => {
          i.name = i.name.toLowerCase();
        });
      }
      renderCrafts();
      renderIngredients();
      renderBuySell();
      calculateProfitability();
    }
    function saveData() {
      localStorage.setItem('crafts', JSON.stringify(crafts));
      localStorage.setItem('ingredients', JSON.stringify(ingredients));
    }

    /* ---------- Utilitaire : Parsing d'un ingrédient ---------- */
    function parseIngredientPart(part) {
      let tokens = part.trim().split(/\s+/);
      if (tokens.length < 2) return null;
      let quantity = parseInt(tokens[0]);
      if (isNaN(quantity)) return null;
      let name = tokens.slice(1).join(" ");
      return { quantity, name };
    }

    /* ---------- Production détaillée ---------- */
    function getInventoryObject() {
      let invObj = {};
      ingredients.forEach(item => {
        let key = item.name.toLowerCase();
        invObj[key] = (invObj[key] || 0) + item.quantity;
      });
      return invObj;
    }
    function produceWithDetails(itemName, quantity, inv) {
      let key = itemName.toLowerCase();
      let available = inv[key] || 0;
      let used = Math.min(available, quantity);
      inv[key] = available - used;
      let detailsHTML = "";
      if (used > 0) {
        detailsHTML += `<li>${used}x ${formatDisplayName(itemName)} (inventaire)</li>`;
      }
      let remainder = quantity - used;
      let net = {};
      if (remainder <= 0) {
        return { net, detailsHTML: `<ul>${detailsHTML}</ul>` };
      }
      let craft = crafts.find(c => c.name.toLowerCase() === key);
      if (craft) {
        detailsHTML += `<li><span class="title">${remainder}x ${formatDisplayName(itemName)}</span></li><li><ul>`;
        let parts = craft.ingredients.split(',');
        parts.forEach(part => {
          let parsed = parseIngredientPart(part);
          if (!parsed) return;
          let reqQuantity = remainder * parsed.quantity;
          let result = produceWithDetails(parsed.name, reqQuantity, inv);
          let inner = result.detailsHTML;
          if (inner.startsWith("<ul>") && inner.endsWith("</ul>")) {
            inner = inner.substring(4, inner.length - 5).trim();
          }
          if (/^<li>.*\(inventaire\)<\/li>$/.test(inner)) {
            detailsHTML += inner;
          } else {
            detailsHTML += `<li><span class="title">${reqQuantity}x ${formatDisplayName(parsed.name)}:</span>${result.detailsHTML}</li>`;
          }
          for (let raw in result.net) {
            net[raw] = (net[raw] || 0) + result.net[raw];
          }
        });
        detailsHTML += `</ul></li>`;
      } else {
        detailsHTML += `<li>${remainder}x ${formatDisplayName(itemName)} (achat)</li>`;
        net[key] = remainder;
      }
      return { net, detailsHTML: `<ul>${detailsHTML}</ul>` };
    }

    /* ---------- Module 1 : Crafts ---------- */
    function openCraftModal() {
      document.getElementById('craftModalTitle').innerText = "Ajouter un Craft";
      document.getElementById('craftId').value = "";
      document.getElementById('craftName').value = "";
      document.getElementById('craftIngredients').value = "";
      document.getElementById('craftResale').value = "";
      document.getElementById('craftModal').style.display = "block";
    }
    function closeCraftModal() {
      document.getElementById('craftModal').style.display = "none";
    }
    function saveCraft() {
      let id = document.getElementById('craftId').value;
      let name = document.getElementById('craftName').value.trim().toLowerCase();
      let ingredientsText = document.getElementById('craftIngredients').value.trim().toLowerCase();
      let resaleValue = parseFloat(document.getElementById('craftResale').value);
      if (name === "" || ingredientsText === "" || isNaN(resaleValue)) {
        alert("Veuillez remplir tous les champs correctement.");
        return;
      }
      if (id) {
        const index = crafts.findIndex(c => c.id === id);
        if (index !== -1) {
          crafts[index] = { id, name, ingredients: ingredientsText, resaleValue };
        }
      } else {
        let newCraft = { id: Date.now().toString(), name, ingredients: ingredientsText, resaleValue };
        crafts.push(newCraft);
      }
      saveData();
      renderCrafts();
      renderBuySell();
      calculateProfitability();
      closeCraftModal();
    }
    function editCraft(id) {
      const craft = crafts.find(c => c.id === id);
      if (craft) {
        document.getElementById('craftModalTitle').innerText = "Modifier un Craft";
        document.getElementById('craftId').value = craft.id;
        document.getElementById('craftName').value = craft.name;
        document.getElementById('craftIngredients').value = craft.ingredients;
        document.getElementById('craftResale').value = craft.resaleValue;
        document.getElementById('craftModal').style.display = "block";
      }
    }
    function deleteCraft(id) {
      if (confirm("Voulez-vous vraiment supprimer ce craft ?")) {
        crafts = crafts.filter(c => c.id !== id);
        saveData();
        renderCrafts();
        renderBuySell();
        calculateProfitability();
      }
    }
    function renderCrafts() {
      const tbody = document.querySelector('#craftTable tbody');
      tbody.innerHTML = "";
      let filtered = crafts.filter(craft => {
        return craft.name.includes(craftFilterText) ||
               craft.ingredients.includes(craftFilterText) ||
               String(craft.resaleValue).includes(craftFilterText);
      });
      if (craftSort.column) {
        filtered.sort((a, b) => {
          let aVal = a[craftSort.column];
          let bVal = b[craftSort.column];
          if (craftSort.column === "resaleValue") {
            return craftSort.direction === "asc" ? aVal - bVal : bVal - aVal;
          } else {
            aVal = aVal.toLowerCase();
            bVal = bVal.toLowerCase();
            if (aVal < bVal) return craftSort.direction === "asc" ? -1 : 1;
            if (aVal > bVal) return craftSort.direction === "asc" ? 1 : -1;
            return 0;
          }
        });
      }
      filtered.forEach(craft => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${formatDisplayName(craft.name)}</td>
          <td>${craft.ingredients}</td>
          <td><input type="number" class="inline-input" value="${craft.resaleValue}" onchange="updateCraftValue('${craft.id}', this.value)"></td>
          <td>
            <button onclick="editCraft('${craft.id}')">Modifier</button>
            <button onclick="deleteCraft('${craft.id}')">Supprimer</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
      updateCraftSortIndicators();
    }

    /* ---------- Module 2 : Inventaire ---------- */
    function openIngredientModal() {
      document.getElementById('ingredientModalTitle').innerText = "Ajouter un ingrédient";
      document.getElementById('ingredientId').value = "";
      document.getElementById('ingredientName').value = "";
      document.getElementById('ingredientQuantity').value = "";
      document.getElementById('ingredientModal').style.display = "block";
    }
    function closeIngredientModal() {
      document.getElementById('ingredientModal').style.display = "none";
    }
    function saveIngredient() {
      let id = document.getElementById('ingredientId').value;
      let name = document.getElementById('ingredientName').value.trim().toLowerCase();
      let quantity = parseFloat(document.getElementById('ingredientQuantity').value);
      if (name === "" || isNaN(quantity)) {
        alert("Veuillez remplir tous les champs correctement.");
        return;
      }
      if (id) {
        const index = ingredients.findIndex(i => i.id === id);
        if (index !== -1) {
          ingredients[index] = { id, name, quantity };
        }
      } else {
        let newIng = { id: Date.now().toString(), name, quantity };
        ingredients.push(newIng);
      }
      saveData();
      renderIngredients();
      closeIngredientModal();
    }
    function editIngredient(id) {
      const ing = ingredients.find(i => i.id === id);
      if (ing) {
        document.getElementById('ingredientModalTitle').innerText = "Modifier un ingrédient";
        document.getElementById('ingredientId').value = ing.id;
        document.getElementById('ingredientName').value = ing.name;
        document.getElementById('ingredientQuantity').value = ing.quantity;
        document.getElementById('ingredientModal').style.display = "block";
      }
    }
    function deleteIngredient(id) {
      if (confirm("Voulez-vous vraiment supprimer cet ingrédient ?")) {
        ingredients = ingredients.filter(i => i.id !== id);
        saveData();
        renderIngredients();
      }
    }
    function renderIngredients() {
      const tbody = document.querySelector('#ingredientTable tbody');
      tbody.innerHTML = "";
      let filtered = ingredients.filter(ing => {
        return ing.name.includes(ingredientFilterText) ||
               String(ing.quantity).includes(ingredientFilterText);
      });
      if (ingredientSort.column) {
        filtered.sort((a, b) => {
          let aVal = a[ingredientSort.column];
          let bVal = b[ingredientSort.column];
          if (ingredientSort.column === "quantity") {
            return ingredientSort.direction === "asc" ? aVal - bVal : bVal - aVal;
          } else {
            aVal = aVal.toLowerCase();
            bVal = bVal.toLowerCase();
            if (aVal < bVal) return ingredientSort.direction === "asc" ? -1 : 1;
            if (aVal > bVal) return ingredientSort.direction === "asc" ? 1 : -1;
            return 0;
          }
        });
      }
      filtered.forEach(ing => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${formatDisplayName(ing.name)}</td>
          <td><input type="number" class="inline-input" value="${ing.quantity}" onchange="updateIngredientQuantity('${ing.id}', this.value)"></td>
          <td>
            <button onclick="editIngredient('${ing.id}')">Modifier</button>
            <button onclick="deleteIngredient('${ing.id}')">Supprimer</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
      updateIngredientSortIndicators();
    }

    /* ---------- Module 3 : Rentabilité ---------- */
    function maxProduction(itemName) {
      let inv = getInventoryObject();
      let count = 0;
      while (tryProduceOne(itemName, inv)) {
        count++;
      }
      return count;
    }
    function tryProduceOne(itemName, inv) {
      let invCopy = Object.assign({}, inv);
      let result = produceWithDetails(itemName, 1, invCopy);
      if (Object.keys(result.net).length === 0) {
        for (let k in invCopy) {
          inv[k] = invCopy[k];
        }
        return true;
      }
      return false;
    }
    function calculateProfitability() {
      const tbody = document.querySelector('#profitTable tbody');
      tbody.innerHTML = "";
      let computedList = [];
      crafts.forEach(craft => {
        const possibleCount = maxProduction(craft.name);
        if (possibleCount > 0) {
          const profit = possibleCount * (craft.resaleValue / 10);
          computedList.push({ craft: craft, possibleCount: possibleCount, profit: profit });
        }
      });
      if (profitFilterText) {
        computedList = computedList.filter(item => {
          return item.craft.name.includes(profitFilterText) ||
                 item.craft.ingredients.includes(profitFilterText) ||
                 String(item.craft.resaleValue).includes(profitFilterText) ||
                 String(item.possibleCount).includes(profitFilterText) ||
                 String(item.profit).includes(profitFilterText);
        });
      }
      if (profitSort.column) {
        computedList.sort((a, b) => {
          let aVal, bVal;
          if (profitSort.column === "craft") {
            aVal = a.craft.name;
            bVal = b.craft.name;
          } else if (profitSort.column === "possibleCount") {
            aVal = a.possibleCount;
            bVal = b.possibleCount;
          } else if (profitSort.column === "profit") {
            aVal = a.profit;
            bVal = b.profit;
          }
          if (typeof aVal === "number") {
            return profitSort.direction === "asc" ? aVal - bVal : bVal - aVal;
          } else {
            aVal = aVal.toLowerCase();
            bVal = bVal.toLowerCase();
            if (aVal < bVal) return profitSort.direction === "asc" ? -1 : 1;
            if (aVal > bVal) return profitSort.direction === "asc" ? 1 : -1;
            return 0;
          }
        });
      }
      computedList.forEach(item => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${formatDisplayName(item.craft.name)}</td>
          <td>${item.possibleCount}</td>
          <td>${item.profit.toFixed(2)}</td>
          <td><button onclick="openConsumptionDetailModal('${item.craft.id}')">Détails</button></td>
        `;
        tr.id = "profit_" + item.craft.id;
        tbody.appendChild(tr);
      });
      updateProfitSortIndicators();
      if (computedList.length > 0) {
        let best = computedList.reduce((max, cur) => cur.profit > max.profit ? cur : max, computedList[0]);
        const bestRow = document.getElementById("profit_" + best.craft.id);
        if (bestRow) {
          bestRow.style.backgroundColor = document.body.classList.contains("dark-theme") ? "#4caf50" : "#b2dba1";
        }
      }
    }

    /* ---------- Module 4 : Calcul de ressources ---------- */
    function renderBuySell() {
      const tbody = document.querySelector('#buySellTable tbody');
      tbody.innerHTML = "";
      let filtered = crafts.filter(craft => {
        return craft.name.includes(buySellFilterText);
      });
      if (buySellSort.column) {
        filtered.sort((a, b) => {
          let aVal = a[buySellSort.column].toLowerCase();
          let bVal = b[buySellSort.column].toLowerCase();
          if (aVal < bVal) return buySellSort.direction === "asc" ? -1 : 1;
          if (aVal > bVal) return buySellSort.direction === "asc" ? 1 : -1;
          return 0;
        });
      }
      filtered.forEach(craft => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${formatDisplayName(craft.name)}</td>
          <td>
            <button onclick="openBuySellModal('${craft.id}')">Calculer</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
      updateBuySellSortIndicators();
    }
    function openBuySellModal(craftId) {
      currentBuySellCraft = crafts.find(c => c.id === craftId);
      if (!currentBuySellCraft) return;
      document.getElementById('buySellModalTitle').innerHTML = `Calcul de ressources - <span id="currentCraftName">${formatDisplayName(currentBuySellCraft.name)}</span>`;
      const bodyDiv = document.getElementById('buySellModalBody');
      bodyDiv.innerHTML = "";
      
      const craftsCountContainer = document.createElement('div');
      craftsCountContainer.style.marginBottom = "15px";
      craftsCountContainer.innerHTML = `
        <label>Nombre de crafts :</label>
        <input type="number" id="buySellCraftCount" value="10" min="1">
      `;
      bodyDiv.appendChild(craftsCountContainer);
      
      const rawReqContainer = document.createElement('div');
      rawReqContainer.id = "rawReqContainer";
      bodyDiv.appendChild(rawReqContainer);
      
      const breakdownContainer = document.createElement('div');
      breakdownContainer.id = "breakdownDetails";
      breakdownContainer.className = "breakdown";
      bodyDiv.appendChild(breakdownContainer);
      
      function updateRawRequirements() {
        const count = parseInt(document.getElementById('buySellCraftCount').value) || 0;
        let invCopy = Object.assign({}, getInventoryObject());
        let result = produceWithDetails(currentBuySellCraft.name, count, invCopy);
        rawReqContainer.innerHTML = "";
        for (let raw in result.net) {
          let q = result.net[raw];
          let container = document.createElement('div');
          container.style.marginBottom = "10px";
          let html = `<strong>${formatDisplayName(raw)} (x${q})</strong><br>`;
          if (q < 10) {
            html += `<label style="font-weight: normal;">Prix par 1:</label>`;
            html += `<input type="number" id="buySellInput_${raw}_1" placeholder="Prix pour 1 unité"><br>`;
          } else if (q < 100) {
            html += `<label style="font-weight: normal;">Prix par 10:</label>`;
            html += `<input type="number" id="buySellInput_${raw}_10" placeholder="Prix pour 10 unités"><br>`;
          } else {
            let count100 = Math.floor(q / 100);
            let remainder = q % 100;
            html += `<label style="font-weight: normal;">Prix par 100:</label>`;
            html += `<input type="number" id="buySellInput_${raw}_100" placeholder="Prix pour 100 unités"><br>`;
            if (remainder >= 10) {
              html += `<label style="font-weight: normal;">Prix par 10:</label>`;
              html += `<input type="number" id="buySellInput_${raw}_10" placeholder="Prix pour 10 unités"><br>`;
            }
            if (remainder % 10 > 0) {
              html += `<label style="font-weight: normal;">Prix par 1:</label>`;
              html += `<input type="number" id="buySellInput_${raw}_1" placeholder="Prix pour 1 unité"><br>`;
            }
          }
          container.innerHTML = html;
          rawReqContainer.appendChild(container);
        }
        breakdownContainer.innerHTML = result.detailsHTML;
      }
      
      updateRawRequirements();
      const craftsCountInput = document.getElementById('buySellCraftCount');
      craftsCountInput.addEventListener('input', updateRawRequirements);
      
      document.getElementById('buySellResult').innerText = "";
      document.getElementById('buySellModal').style.display = "block";
    }
    function calculateBuySell() {
      if (!currentBuySellCraft) return;
      const craftsCount = parseInt(document.getElementById('buySellCraftCount').value) || 10;
      let invCopy = Object.assign({}, getInventoryObject());
      let result = produceWithDetails(currentBuySellCraft.name, craftsCount, invCopy);
      let totalCost = 0, valid = true;
      let resourceCosts = {};
      for (let raw in result.net) {
        let q = result.net[raw];
        let cost = 0;
        if (q < 10) {
          let input = document.getElementById(`buySellInput_${raw}_1`);
          if (!input) { valid = false; break; }
          let price1 = parseFloat(input.value);
          if (isNaN(price1)) { valid = false; break; }
          cost = price1 * q;
        } else if (q < 100) {
          let input = document.getElementById(`buySellInput_${raw}_10`);
          if (!input) { valid = false; break; }
          let price10 = parseFloat(input.value);
          if (isNaN(price10)) { valid = false; break; }
          cost = price10 * (q / 10);
        } else {
          let count100 = Math.floor(q / 100);
          let remainder = q % 100;
          let cost100 = 0, cost10 = 0, cost1 = 0;
          let input100 = document.getElementById(`buySellInput_${raw}_100`);
          if (!input100) { valid = false; break; }
          let price100 = parseFloat(input100.value);
          if (isNaN(price100)) { valid = false; break; }
          cost100 = price100 * count100;
          if (remainder >= 10) {
            let input10 = document.getElementById(`buySellInput_${raw}_10`);
            if (!input10) { valid = false; break; }
            let count10 = Math.floor(remainder / 10);
            let price10 = parseFloat(input10.value);
            if (isNaN(price10)) { valid = false; break; }
            cost10 = price10 * count10;
          }
          if (remainder % 10 > 0) {
            let input1 = document.getElementById(`buySellInput_${raw}_1`);
            if (!input1) { valid = false; break; }
            let price1 = parseFloat(input1.value);
            if (isNaN(price1)) { valid = false; break; }
            cost1 = price1 * (remainder % 10);
          }
          cost = cost100 + cost10 + cost1;
        }
        resourceCosts[raw] = cost;
        totalCost += cost;
      }
      if (!valid) {
        alert("Veuillez renseigner le prix d'achat pour chaque ressource.");
        return;
      }
      const resaleTotal = (currentBuySellCraft.resaleValue * craftsCount) / 10;
      const diff = resaleTotal - totalCost;
      
      let resultHTML = `<div class="result-container">
        <h3>Résultat</h3>
        <table class="result-table">
          <tr><th>Valeur de revente estimée</th><td>${resaleTotal.toFixed(2)} kamas</td></tr>
          <tr><th>Coût total des ressources</th><td>${totalCost.toFixed(2)} kamas</td></tr>
          <tr><th>Différence</th><td>${diff > 0 ? "Profit: " + diff.toFixed(2) + " kamas" : (diff < 0 ? "Perte: " + Math.abs(diff).toFixed(2) + " kamas" : "Équilibre")}</td></tr>
        </table>
        <h3>Détail des coûts</h3>
        <table class="breakdown-table">
          <thead>
            <tr>
              <th>Ressource</th>
              <th>Coût</th>
            </tr>
          </thead>
          <tbody>`;
      for (let raw in resourceCosts) {
        resultHTML += `<tr><td>${formatDisplayName(raw)}</td><td>${resourceCosts[raw].toFixed(2)} kamas</td></tr>`;
      }
      resultHTML += `</tbody></table></div>`;
      
      document.getElementById('buySellResult').innerHTML = resultHTML;
    }
    function closeBuySellModal() {
      document.getElementById('buySellModal').style.display = "none";
    }

    /* ---------- Module 3 : Détails de consommation ---------- */
    function openConsumptionDetailModal(craftId) {
      const craft = crafts.find(c => c.id === craftId);
      if (!craft) return;
      let maxCount = maxProduction(craft.name);
      let invCopy = Object.assign({}, getInventoryObject());
      let result = produceWithDetails(craft.name, maxCount, invCopy);
      document.getElementById('consumptionModalBody').innerHTML = result.detailsHTML;
      document.getElementById('consumptionModalTitle').innerText = "Détails de consommation - " + formatDisplayName(craft.name) + " (" + maxCount + " crafts)";
      document.getElementById('consumptionModal').style.display = "block";
    }
    function closeConsumptionModal() {
      document.getElementById('consumptionModal').style.display = "none";
    }

    /* ---------- Module 4 : Calcul de ressources ---------- */
    function renderBuySell() {
      const tbody = document.querySelector('#buySellTable tbody');
      tbody.innerHTML = "";
      let filtered = crafts.filter(craft => {
        return craft.name.includes(buySellFilterText);
      });
      if (buySellSort.column) {
        filtered.sort((a, b) => {
          let aVal = a[buySellSort.column].toLowerCase();
          let bVal = b[buySellSort.column].toLowerCase();
          if (aVal < bVal) return buySellSort.direction === "asc" ? -1 : 1;
          if (aVal > bVal) return buySellSort.direction === "asc" ? 1 : -1;
          return 0;
        });
      }
      filtered.forEach(craft => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${formatDisplayName(craft.name)}</td>
          <td>
            <button onclick="openBuySellModal('${craft.id}')">Calculer</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
      updateBuySellSortIndicators();
    }

    /* ---------- Modal Reset Données ---------- */
    function openResetModal() {
      document.getElementById('resetModal').style.display = "block";
    }
    function closeResetModal() {
      document.getElementById('resetModal').style.display = "none";
    }
    function resetData() {
      localStorage.clear();
      crafts = [];
      ingredients = [];
      renderCrafts();
      renderIngredients();
      renderBuySell();
      calculateProfitability();
      closeResetModal();
      alert("Les données ont été réinitialisées.");
    }

    /* ---------- Fonctions d'édition inline ---------- */
    function updateCraftValue(craftId, newValue) {
      let craft = crafts.find(c => c.id === craftId);
      if (craft) {
        craft.resaleValue = parseFloat(newValue) || 0;
        saveData();
        renderCrafts();
        renderBuySell();
        calculateProfitability();
      }
    }
    function updateIngredientQuantity(ingId, newQuantity) {
      let ing = ingredients.find(i => i.id === ingId);
      if (ing) {
        ing.quantity = parseFloat(newQuantity) || 0;
        saveData();
        renderIngredients();
        renderBuySell();
        calculateProfitability();
      }
    }

    /* ---------- Fonctions de tri ---------- */
    function toggleCraftSort(column) {
      if (craftSort.column === column) {
        craftSort.direction = craftSort.direction === "asc" ? "desc" : "asc";
      } else {
        craftSort.column = column;
        craftSort.direction = "asc";
      }
      renderCrafts();
    }
    function toggleIngredientSort(column) {
      if (ingredientSort.column === column) {
        ingredientSort.direction = ingredientSort.direction === "asc" ? "desc" : "asc";
      } else {
        ingredientSort.column = column;
        ingredientSort.direction = "asc";
      }
      renderIngredients();
    }
    function toggleProfitSort(column) {
      if (profitSort.column === column) {
        profitSort.direction = profitSort.direction === "asc" ? "desc" : "asc";
      } else {
        profitSort.column = column;
        profitSort.direction = "asc";
      }
      calculateProfitability();
    }
    function toggleBuySellSort(column) {
      if (buySellSort.column === column) {
        buySellSort.direction = buySellSort.direction === "asc" ? "desc" : "asc";
      } else {
        buySellSort.column = column;
        buySellSort.direction = "asc";
      }
      renderBuySell();
    }

    /* ---------- Mise à jour des indicateurs de tri ---------- */
    function updateCraftSortIndicators() {
      const cols = ["name", "ingredients", "resaleValue"];
      cols.forEach(col => {
        const span = document.getElementById("craft-sort-" + col);
        if (craftSort.column === col) {
          span.textContent = craftSort.direction === "asc" ? "▲" : "▼";
          span.classList.add("active");
        } else {
          span.textContent = "";
          span.classList.remove("active");
        }
      });
    }
    function updateIngredientSortIndicators() {
      const cols = ["name", "quantity"];
      cols.forEach(col => {
        const span = document.getElementById("ingredient-sort-" + col);
        if (ingredientSort.column === col) {
          span.textContent = ingredientSort.direction === "asc" ? "▲" : "▼";
          span.classList.add("active");
        } else {
          span.textContent = "";
          span.classList.remove("active");
        }
      });
    }
    function updateProfitSortIndicators() {
      const cols = ["craft", "possibleCount", "profit"];
      cols.forEach(col => {
        const span = document.getElementById("profit-sort-" + col);
        if (profitSort.column === col) {
          span.textContent = profitSort.direction === "asc" ? "▲" : "▼";
          span.classList.add("active");
        } else {
          span.textContent = "";
          span.classList.remove("active");
        }
      });
    }
    function updateBuySellSortIndicators() {
      const span = document.getElementById("buySell-sort-name");
      if (buySellSort.column === "name") {
        span.textContent = buySellSort.direction === "asc" ? "▲" : "▼";
        span.classList.add("active");
      } else {
        span.textContent = "";
        span.classList.remove("active");
      }
    }

    /* ---------- Gestion des modales ---------- */
    window.onclick = function(event) {
      const modals = ["craftModal", "ingredientModal", "buySellModal", "consumptionModal", "resetModal"];
      modals.forEach(id => {
        const modal = document.getElementById(id);
        if (event.target === modal) {
          modal.style.display = "none";
        }
      });
    };
    document.getElementById('craftModal').addEventListener('keydown', function(event) {
      if (event.key === "Enter") {
        event.preventDefault();
        saveCraft();
      }
    });
    document.getElementById('ingredientModal').addEventListener('keydown', function(event) {
      if (event.key === "Enter") {
        event.preventDefault();
        saveIngredient();
      }
    });
    document.getElementById('buySellModal').addEventListener('keydown', function(event) {
      if (event.key === "Enter") {
        event.preventDefault();
        calculateBuySell();
      }
    });
    function closeAllModals() {
      ["craftModal", "ingredientModal", "buySellModal", "consumptionModal", "resetModal"].forEach(id => {
        document.getElementById(id).style.display = "none";
      });
    }
    window.addEventListener('keydown', function(event) {
      if (event.key === "Escape") {
        closeAllModals();
      }
    });

    /* ---------- Fonctions d'édition inline ---------- */
    function updateCraftValue(craftId, newValue) {
      let craft = crafts.find(c => c.id === craftId);
      if (craft) {
        craft.resaleValue = parseFloat(newValue) || 0;
        saveData();
        renderCrafts();
        renderBuySell();
        calculateProfitability();
      }
    }
    function updateIngredientQuantity(ingId, newQuantity) {
      let ing = ingredients.find(i => i.id === ingId);
      if (ing) {
        ing.quantity = parseFloat(newQuantity) || 0;
        saveData();
        renderIngredients();
        renderBuySell();
        calculateProfitability();
      }
    }

    /* ---------- Module 4 : Calcul de ressources ---------- */
    function openBuySellModal(craftId) {
      currentBuySellCraft = crafts.find(c => c.id === craftId);
      if (!currentBuySellCraft) return;
      document.getElementById('buySellModalTitle').innerHTML = `Calcul de ressources - <span id="currentCraftName">${formatDisplayName(currentBuySellCraft.name)}</span>`;
      const bodyDiv = document.getElementById('buySellModalBody');
      bodyDiv.innerHTML = "";
      
      const craftsCountContainer = document.createElement('div');
      craftsCountContainer.style.marginBottom = "15px";
      craftsCountContainer.innerHTML = `
        <label>Nombre de crafts :</label>
        <input type="number" id="buySellCraftCount" value="10" min="1">
      `;
      bodyDiv.appendChild(craftsCountContainer);
      
      const rawReqContainer = document.createElement('div');
      rawReqContainer.id = "rawReqContainer";
      bodyDiv.appendChild(rawReqContainer);
      
      const breakdownContainer = document.createElement('div');
      breakdownContainer.id = "breakdownDetails";
      breakdownContainer.className = "breakdown";
      bodyDiv.appendChild(breakdownContainer);
      
      function updateRawRequirements() {
        const count = parseInt(document.getElementById('buySellCraftCount').value) || 0;
        let invCopy = Object.assign({}, getInventoryObject());
        let result = produceWithDetails(currentBuySellCraft.name, count, invCopy);
        rawReqContainer.innerHTML = "";
        for (let raw in result.net) {
          let q = result.net[raw];
          let container = document.createElement('div');
          container.style.marginBottom = "10px";
          let html = `<strong>${formatDisplayName(raw)} (x${q})</strong><br>`;
          if (q < 10) {
            html += `<label style="font-weight: normal;">Prix par 1:</label>`;
            html += `<input type="number" id="buySellInput_${raw}_1" placeholder="Prix pour 1 unité"><br>`;
          } else if (q < 100) {
            html += `<label style="font-weight: normal;">Prix par 10:</label>`;
            html += `<input type="number" id="buySellInput_${raw}_10" placeholder="Prix pour 10 unités"><br>`;
          } else {
            let count100 = Math.floor(q / 100);
            let remainder = q % 100;
            html += `<label style="font-weight: normal;">Prix par 100:</label>`;
            html += `<input type="number" id="buySellInput_${raw}_100" placeholder="Prix pour 100 unités"><br>`;
            if (remainder >= 10) {
              html += `<label style="font-weight: normal;">Prix par 10:</label>`;
              html += `<input type="number" id="buySellInput_${raw}_10" placeholder="Prix pour 10 unités"><br>`;
            }
            if (remainder % 10 > 0) {
              html += `<label style="font-weight: normal;">Prix par 1:</label>`;
              html += `<input type="number" id="buySellInput_${raw}_1" placeholder="Prix pour 1 unité"><br>`;
            }
          }
          container.innerHTML = html;
          rawReqContainer.appendChild(container);
        }
        breakdownContainer.innerHTML = result.detailsHTML;
      }
      
      updateRawRequirements();
      const craftsCountInput = document.getElementById('buySellCraftCount');
      craftsCountInput.addEventListener('input', updateRawRequirements);
      
      document.getElementById('buySellResult').innerText = "";
      document.getElementById('buySellModal').style.display = "block";
    }
    function calculateBuySell() {
      if (!currentBuySellCraft) return;
      const craftsCount = parseInt(document.getElementById('buySellCraftCount').value) || 10;
      let invCopy = Object.assign({}, getInventoryObject());
      let result = produceWithDetails(currentBuySellCraft.name, craftsCount, invCopy);
      let totalCost = 0, valid = true;
      let resourceCosts = {};
      for (let raw in result.net) {
        let q = result.net[raw];
        let cost = 0;
        if (q < 10) {
          let input = document.getElementById(`buySellInput_${raw}_1`);
          if (!input) { valid = false; break; }
          let price1 = parseFloat(input.value);
          if (isNaN(price1)) { valid = false; break; }
          cost = price1 * q;
        } else if (q < 100) {
          let input = document.getElementById(`buySellInput_${raw}_10`);
          if (!input) { valid = false; break; }
          let price10 = parseFloat(input.value);
          if (isNaN(price10)) { valid = false; break; }
          cost = price10 * (q / 10);
        } else {
          let count100 = Math.floor(q / 100);
          let remainder = q % 100;
          let cost100 = 0, cost10 = 0, cost1 = 0;
          let input100 = document.getElementById(`buySellInput_${raw}_100`);
          if (!input100) { valid = false; break; }
          let price100 = parseFloat(input100.value);
          if (isNaN(price100)) { valid = false; break; }
          cost100 = price100 * count100;
          if (remainder >= 10) {
            let input10 = document.getElementById(`buySellInput_${raw}_10`);
            if (!input10) { valid = false; break; }
            let count10 = Math.floor(remainder / 10);
            let price10 = parseFloat(input10.value);
            if (isNaN(price10)) { valid = false; break; }
            cost10 = price10 * count10;
          }
          if (remainder % 10 > 0) {
            let input1 = document.getElementById(`buySellInput_${raw}_1`);
            if (!input1) { valid = false; break; }
            let price1 = parseFloat(input1.value);
            if (isNaN(price1)) { valid = false; break; }
            cost1 = price1 * (remainder % 10);
          }
          cost = cost100 + cost10 + cost1;
        }
        resourceCosts[raw] = cost;
        totalCost += cost;
      }
      if (!valid) {
        alert("Veuillez renseigner le prix d'achat pour chaque ressource.");
        return;
      }
      const resaleTotal = (currentBuySellCraft.resaleValue * craftsCount) / 10;
      const diff = resaleTotal - totalCost;
      
      let resultHTML = `<div class="result-container">
        <h3>Résultat</h3>
        <table class="result-table">
          <tr><th>Valeur de revente estimée</th><td>${resaleTotal.toFixed(2)} kamas</td></tr>
          <tr><th>Coût total des ressources</th><td>${totalCost.toFixed(2)} kamas</td></tr>
          <tr><th>Différence</th><td>${diff > 0 ? "Profit: " + diff.toFixed(2) + " kamas" : (diff < 0 ? "Perte: " + Math.abs(diff).toFixed(2) + " kamas" : "Équilibre")}</td></tr>
        </table>
        <h3>Détail des coûts</h3>
        <table class="breakdown-table">
          <thead>
            <tr>
              <th>Ressource</th>
              <th>Coût</th>
            </tr>
          </thead>
          <tbody>`;
      for (let raw in resourceCosts) {
        resultHTML += `<tr><td>${formatDisplayName(raw)}</td><td>${resourceCosts[raw].toFixed(2)} kamas</td></tr>`;
      }
      resultHTML += `</tbody></table></div>`;
      
      document.getElementById('buySellResult').innerHTML = resultHTML;
    }
    function closeBuySellModal() {
      document.getElementById('buySellModal').style.display = "none";
    }

    /* ---------- Module 3 : Détails de consommation ---------- */
    function openConsumptionDetailModal(craftId) {
      const craft = crafts.find(c => c.id === craftId);
      if (!craft) return;
      let maxCount = maxProduction(craft.name);
      let invCopy = Object.assign({}, getInventoryObject());
      let result = produceWithDetails(craft.name, maxCount, invCopy);
      document.getElementById('consumptionModalBody').innerHTML = result.detailsHTML;
      document.getElementById('consumptionModalTitle').innerText = "Détails de consommation - " + formatDisplayName(craft.name) + " (" + maxCount + " crafts)";
      document.getElementById('consumptionModal').style.display = "block";
    }
    function closeConsumptionModal() {
      document.getElementById('consumptionModal').style.display = "none";
    }

    /* ---------- Module 4 : Calcul de ressources ---------- */
    function renderBuySell() {
      const tbody = document.querySelector('#buySellTable tbody');
      tbody.innerHTML = "";
      let filtered = crafts.filter(craft => {
        return craft.name.includes(buySellFilterText);
      });
      if (buySellSort.column) {
        filtered.sort((a, b) => {
          let aVal = a[buySellSort.column].toLowerCase();
          let bVal = b[buySellSort.column].toLowerCase();
          if (aVal < bVal) return buySellSort.direction === "asc" ? -1 : 1;
          if (aVal > bVal) return buySellSort.direction === "asc" ? 1 : -1;
          return 0;
        });
      }
      filtered.forEach(craft => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${formatDisplayName(craft.name)}</td>
          <td>
            <button onclick="openBuySellModal('${craft.id}')">Calculer</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
      updateBuySellSortIndicators();
    }

    /* ---------- Modal Reset Données ---------- */
    function openResetModal() {
      document.getElementById('resetModal').style.display = "block";
    }
    function closeResetModal() {
      document.getElementById('resetModal').style.display = "none";
    }
    function resetData() {
      localStorage.clear();
      crafts = [];
      ingredients = [];
      renderCrafts();
      renderIngredients();
      renderBuySell();
      calculateProfitability();
      closeResetModal();
      alert("Les données ont été réinitialisées.");
    }

    /* ---------- Fonctions d'édition inline ---------- */
    function updateCraftValue(craftId, newValue) {
      let craft = crafts.find(c => c.id === craftId);
      if (craft) {
        craft.resaleValue = parseFloat(newValue) || 0;
        saveData();
        renderCrafts();
        renderBuySell();
        calculateProfitability();
      }
    }
    function updateIngredientQuantity(ingId, newQuantity) {
      let ing = ingredients.find(i => i.id === ingId);
      if (ing) {
        ing.quantity = parseFloat(newQuantity) || 0;
        saveData();
        renderIngredients();
        renderBuySell();
        calculateProfitability();
      }
    }

    /* ---------- Fonctions de tri ---------- */
    function toggleCraftSort(column) {
      if (craftSort.column === column) {
        craftSort.direction = craftSort.direction === "asc" ? "desc" : "asc";
      } else {
        craftSort.column = column;
        craftSort.direction = "asc";
      }
      renderCrafts();
    }
    function toggleIngredientSort(column) {
      if (ingredientSort.column === column) {
        ingredientSort.direction = ingredientSort.direction === "asc" ? "desc" : "asc";
      } else {
        ingredientSort.column = column;
        ingredientSort.direction = "asc";
      }
      renderIngredients();
    }
    function toggleProfitSort(column) {
      if (profitSort.column === column) {
        profitSort.direction = profitSort.direction === "asc" ? "desc" : "asc";
      } else {
        profitSort.column = column;
        profitSort.direction = "asc";
      }
      calculateProfitability();
    }
    function toggleBuySellSort(column) {
      if (buySellSort.column === column) {
        buySellSort.direction = buySellSort.direction === "asc" ? "desc" : "asc";
      } else {
        buySellSort.column = column;
        buySellSort.direction = "asc";
      }
      renderBuySell();
    }

    /* ---------- Mise à jour des indicateurs de tri ---------- */
    function updateCraftSortIndicators() {
      const cols = ["name", "ingredients", "resaleValue"];
      cols.forEach(col => {
        const span = document.getElementById("craft-sort-" + col);
        if (craftSort.column === col) {
          span.textContent = craftSort.direction === "asc" ? "▲" : "▼";
          span.classList.add("active");
        } else {
          span.textContent = "";
          span.classList.remove("active");
        }
      });
    }
    function updateIngredientSortIndicators() {
      const cols = ["name", "quantity"];
      cols.forEach(col => {
        const span = document.getElementById("ingredient-sort-" + col);
        if (ingredientSort.column === col) {
          span.textContent = ingredientSort.direction === "asc" ? "▲" : "▼";
          span.classList.add("active");
        } else {
          span.textContent = "";
          span.classList.remove("active");
        }
      });
    }
    function updateProfitSortIndicators() {
      const cols = ["craft", "possibleCount", "profit"];
      cols.forEach(col => {
        const span = document.getElementById("profit-sort-" + col);
        if (profitSort.column === col) {
          span.textContent = profitSort.direction === "asc" ? "▲" : "▼";
          span.classList.add("active");
        } else {
          span.textContent = "";
          span.classList.remove("active");
        }
      });
    }
    function updateBuySellSortIndicators() {
      const span = document.getElementById("buySell-sort-name");
      if (buySellSort.column === "name") {
        span.textContent = buySellSort.direction === "asc" ? "▲" : "▼";
        span.classList.add("active");
      } else {
        span.textContent = "";
        span.classList.remove("active");
      }
    }

    /* ---------- Gestion des modales ---------- */
    window.onclick = function(event) {
      const modals = ["craftModal", "ingredientModal", "buySellModal", "consumptionModal", "resetModal"];
      modals.forEach(id => {
        const modal = document.getElementById(id);
        if (event.target === modal) {
          modal.style.display = "none";
        }
      });
    };
    document.getElementById('craftModal').addEventListener('keydown', function(event) {
      if (event.key === "Enter") {
        event.preventDefault();
        saveCraft();
      }
    });
    document.getElementById('ingredientModal').addEventListener('keydown', function(event) {
      if (event.key === "Enter") {
        event.preventDefault();
        saveIngredient();
      }
    });
    document.getElementById('buySellModal').addEventListener('keydown', function(event) {
      if (event.key === "Enter") {
        event.preventDefault();
        calculateBuySell();
      }
    });
    function closeAllModals() {
      ["craftModal", "ingredientModal", "buySellModal", "consumptionModal", "resetModal"].forEach(id => {
        document.getElementById(id).style.display = "none";
      });
    }
    window.addEventListener('keydown', function(event) {
      if (event.key === "Escape") {
        closeAllModals();
      }
    });

    /* ---------- Initialisation ---------- */
    window.addEventListener('load', loadData);

    // Rendre les fonctions de tri et d'ouverture/modification accessibles globalement
    window.toggleCraftSort = function(column) {
      if (craftSort.column === column) {
        craftSort.direction = craftSort.direction === "asc" ? "desc" : "asc";
      } else {
        craftSort.column = column;
        craftSort.direction = "asc";
      }
      renderCrafts();
    };
    window.toggleIngredientSort = function(column) {
      if (ingredientSort.column === column) {
        ingredientSort.direction = ingredientSort.direction === "asc" ? "desc" : "asc";
      } else {
        ingredientSort.column = column;
        ingredientSort.direction = "asc";
      }
      renderIngredients();
    };
    window.toggleProfitSort = function(column) {
      if (profitSort.column === column) {
        profitSort.direction = profitSort.direction === "asc" ? "desc" : "asc";
      } else {
        profitSort.column = column;
        profitSort.direction = "asc";
      }
      calculateProfitability();
    };
    window.toggleBuySellSort = function(column) {
      if (buySellSort.column === column) {
        buySellSort.direction = buySellSort.direction === "asc" ? "desc" : "asc";
      } else {
        buySellSort.column = column;
        buySellSort.direction = "asc";
      }
      renderBuySell();
    };
    window.openCraftModal = openCraftModal;
    window.closeCraftModal = closeCraftModal;
    window.saveCraft = saveCraft;
    window.editCraft = editCraft;
    window.deleteCraft = deleteCraft;
    window.openIngredientModal = openIngredientModal;
    window.closeIngredientModal = closeIngredientModal;
    window.saveIngredient = saveIngredient;
    window.editIngredient = editIngredient;
    window.deleteIngredient = deleteIngredient;
    window.openConsumptionDetailModal = openConsumptionDetailModal;
    window.closeConsumptionModal = closeConsumptionModal;
    window.openResetModal = openResetModal;
    window.closeResetModal = closeResetModal;
    window.resetData = resetData;
    window.toggleTheme = toggleTheme;
    window.calculateProfitability = calculateProfitability;
    window.renderBuySell = renderBuySell;
    window.openBuySellModal = openBuySellModal;
    window.calculateBuySell = calculateBuySell;
    window.updateCraftValue = updateCraftValue;
    window.updateIngredientQuantity = updateIngredientQuantity;
  </script>
</body>
</html>
